{% extends "base.html" %}


{% block content %}
    <h1>Поиск выдуманных фильмов на любой вкус!</h1>
    
    <div class="search-box">
        <form id="searchForm" action="/search" method="GET">
            <div>
                <input type="text"
                       name="movie"
                       placeholder="Чего изволим?"
                       id="searchInput"
                       autocomplete="off">
            </div>
            
            <div class="filters">
                <div>
                    <label>Год выпуска:</label>
                    <input type="number" name="min_year" placeholder="От" min="1890" max="2030">
                    <input type="number" name="max_year" placeholder="До" min="1890" max="2030">
                </div>
                
                <div>
                    <label>
                        <input type="checkbox" name="nsfw" id="nsfwCheckbox">
                        Exclude NSFW
                    </label>
                </div>
            </div>
            
            <button type="submit">Найти</button>
        </form>
    </div>
    
    <div id="results">
        {% if results %}
            <h2>Найдено фильмов: {{ results|length }}</h2>
            {% for movie in results %}
                <div class="movie-card">
                    <h3>{{ movie.title }} ({{ movie.release_year }})</h3>
                    <p><strong>Описание:</strong> {{ movie.description }}</p>
                    <p><strong>MPAA рейтинг:</strong> {{ movie.rating }}</p>
                </div>
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('results');
    const searchForm = document.getElementById('searchForm');
    let searchTimeout;

    async function performSearch() {
        clearTimeout(searchTimeout);
        
        searchTimeout = setTimeout(async () => {
            const formData = new FormData(searchForm);
            const minYear = formData.get('min_year');
            const maxYear = formData.get('max_year');
            
            // аалидация годов
            if (minYear && (minYear < 1890 || minYear > 2030)) {
                resultsDiv.innerHTML = '<p>Минимальный год должен быть между 1890 и 2030.</p>';
                return;
            }
            if (maxYear && (maxYear < 1890 || maxYear > 2030)) {
                resultsDiv.innerHTML = '<p>Максимальный год должен быть между 1890 и 2030.</p>';
                return;
            }
            if (minYear && maxYear && Number(minYear) > Number(maxYear)) {
                resultsDiv.innerHTML = '<p>Минимальный год не может быть больше максимального.</p>';
                return;
            }
            
            const params = new URLSearchParams(formData).toString();
            
            // пустые запросы
            if (!formData.get('movie') && !minYear && !maxYear) {
                resultsDiv.innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`/api/search?${params}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.errors.join(", "));
                }
                const movies = await response.json();
                
                let html = '';
                if (movies.length > 0) {
                    html += `<h2>Найдено фильмов: ${movies.length}</h2>`;
                    movies.forEach(movie => {
                        html += `
                            <div class="movie-card">
                                <h3>${movie.title} (${movie.release_year})</h3>
                                <p><strong>Описание:</strong> ${movie.description}</p>
                                <p><strong>Рейтинг:</strong> ${movie.rating}</p>
                            </div>
                        `;
                    });
                } else {
                    html = '<p>Ничего не найдено</p>';
                }
                resultsDiv.innerHTML = html;
                
                } catch (error) {
                    console.error('Ошибка:', error);
                    resultsDiv.innerHTML = `<p class="error">${error.message}</p>`;
                }
        }, 700); // Задержка в 700 мс
    }

    // слушаем все изменения формы
    searchForm.addEventListener('input', performSearch);
</script>
{% endblock %}